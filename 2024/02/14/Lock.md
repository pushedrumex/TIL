
## MySQL 엔진의 잠금

- MySQL 에서 사용되는 잠금은 스토리지 엔진 레벨과 MySQL 엔진 레벨이 존재
- MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치는 반면에, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 같 영향을 미치지 않음

### 글로벌 락

```sql
FLUSH TABLES WITH READ LOCK
```

- 한 세션이 글로벌 락을 획득하면 다른 세션에서는 SELECT 를 제외한 대부분의 DDL, DML 문장 실행 불가

### 테이블 락

```sql
LOCK TABLES table_name [ READ | WRITE ]
```

- 개별 테이블 단위로 설정되는 잠금
- Innodb 에서는 대부분의 DML 쿼리에서는 테이블락이 걸리지 않고 스키마를 변경하는 DDL 쿼리일 경우에만 영향을 미침

### 네임드 락

```sql
SELECT GET_LOCK('lockName', 2)
```

- 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금

### 메타데이터 락

```sql
RENAME TABLE tab_a TO tab_b
```

- 데이터베이스의 객체의 이름이나 구조를 변경하는 경우 묵시적으로 획득하는 잠금

## InnoDB 스토리지 엔진 잠금

### 레코드 락

- 레코드 자체 만을 잠그는 것
- InnoDB 스토리지 엔진은 테이블의 레코드가 아닌 **인덱스의 레코드를 잠금**
- 인덱스를 통해 검색되는 모든 레코드를 잠금
    - 조건문에 인덱스 컬럼이 없다면 테이블을 풀스캔하면서 모든 레코드를 잠금
- 인덱스가 하나도 없는 테이블은 내부적으로 자동 생성된 클러스터 인덱스를 이용해 잠금을 설정
- 인덱스가 여러개라면 더 좁은 범위의 인덱스를 잠금

<aside>
💡 InnoDB에서는 대부분 보조 인덱스를 이용한 변경 작업은 네스트 키 락 또는 갭 락을 사용하지만, PK 또는 유니크 인덱스에 의한 변경 작업은 레코드 자체에 대해서만 락을 건다.

</aside>

### 갭 락

- 레코드 자체가 아닌 레코드와 바로 인접한 레코드 사이의 간격만을 잠금
- 레코드와 레코드 사이의 간격에 새로운 레코드가 생성(INSERT) 되는 것을 제어

### 넥스트 키 락

- 레코드 락과 갭 락을 합쳐놓은 형태
- 보통은 갭락을 단독으로 사용하지 않고 넥스트키락의 일부로 함께 사용

### 자동 증가 락

- 각 레코드가 중복되지 않고 저장된 순서대로 증가하는 일련번호의 값을 갖기 위한 잠금