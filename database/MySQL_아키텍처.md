## MySQL의 전체 구조

- Mysql 서버는 **Mysql 엔진**(머리)과 **스토리지 엔진**(손, 발)으로 구분
- InnoDB 스토리지 엔진: MySQL 서버에서 기본적으로 제공되는 스토리지 엔진

### MySQL 엔진

요청된 SQL 문장을 분석하거나 최적화하는 등 DBMS의 두뇌에 해당하는 처리를 수행

- 커넥션 핸들러: 클라이언트로부터의 접속 및 쿼리 요청을 처리
- SQL 파서 및 전처리기
- 옵티마이저: 최적화된 쿼리 실행

### 스토리지 엔진

실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어옴

- MySQL 서버에서 여러 개의 스토리 엔진을 동시에 사용 가능
- 스토리지 엔진은 성능 향상을 위해 키 캐시나 InnoDB 버퍼 풀과 같은 기능을 내장

### 핸들러 API

MySQL 엔진와 InnoDB 스토리지가 데이터를 주고받을 때 사용하는 API

## MySQL 스레딩 구조
- MySQL 서버는 프로세스 기반이 아닌 스레드 기반으로 작동하며 포그라운드 스레드와 백그라운드 스레드로 구분

### 포그라운드 스레드(클라이언트 스레드)

- 클라이언트 사용자가 요청하는 쿼리 문장을 처리
- 최소한 MySQL 서버에 접속된 클라이언트의 수만큼 존재
- 사용자가 커넥션을 종료하면 스레드는 스레드 캐시로 돌아감

### 백그라운드 스레드

- 로그를 디스크로 기록
- 버퍼의 데이터를 디스크로 내려씀
- 쓰기 쿼리가 발생한 경우 버퍼링해서 일괄 처리

### MySQL 에서 쿼리가 실행되는 과정

1. 쿼리 파서
    - 쿼리 문장을 토큰으로 분리해 트리 형태 구조로 만든다.
    - 쿼리 문장의 문법 오류는 이 과정에서 발견된다.
2. 전처리기
    - 생성된 트리 기반으로 쿼리에 구조적인 문제가 있는지 확인한다.
    - 테이블 이름, 컬럼 이름 등의 존재 여부와 접근 권한 등을 확인한다.
3. 옵티마이저
    - 사용자의 요청을 들어온 쿼리 문장을 저렴한 비용으로 빠르게 처리할지를 결정하는 역할
    - 쿼리 변환, 비용 최적화, 실행 계획 수립
4. 실행 엔진
    - 옵티마이저가 만든 실행 계획대로 각 핸들러에게 요청해서 받은 결과를 또 다른 핸들러 요청의 입력으로 연결하는 역할을 수행

# InnoDB 스토리엔진 아키텍처

- InnoDB의 모든 테이블을 기본적으로 PK를 기준으로 클러스터링되어 저장
    - PK는 클러스터링 인덱스
- InnoDB 에서 외래 키는 부모 테이블이나 자식 테이블 모두 해당 칼럼에 인덱스 생성이 필요하고 변경시에는 반드시 부모 테이블이나 자식 테이블에 데이터가 있는 지 체크하는 작업이 필요하므로 잠금이 여러 테이블로 전파된다.

→ 외래키 존재에 주의 필수